<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title data-i18n-key="page-title">Network Games</title>

  <link rel="icon" href="data:,">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
        crossorigin="anonymous">
</head>
<body>
  <div class="container">
    <div class="row flex-column align-items-center" id="alerts"></div>

    <div class="row mt-3">
      <div class="col-12">
        <h1 data-i18n-key="index-title"></h1>
        <p data-i18n-key="welcome-1"></p>
        <div class="list-group" id="rooms"></div>
      </div>
    </div>
  </div><!-- /.container -->

  <script src="/percolation-game/js/i18n.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
          integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
          crossorigin="anonymous"></script>
  <script>
    const URL_PREFIX = '/' + window.location.pathname.split('/')[1];


    function createAlert(message, type = 'danger', title = false) {
      if (title === false)  title = i18n.t('error') + '.'
      var $alert = $(`
        <div class="alert alert-${type} mt-3 alert-dismissible fade show" role="alert">
          <strong>${title}</strong> ${message}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      `);
      $('#alerts').append($alert);
      $alert.alert();
    }

    function handleAjaxError(req) {
      if (req.readyState === 4 && req.status === 400) {
        createAlert(req.getResponseHeader('message'));
      }
    }


    // retrieve overview of rooms, populate list
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.overrideMimeType('application/json');
    xmlHttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        var data = JSON.parse(this.responseText),
            $list = $('#rooms'),
            url = new URL(document.location);
        data.forEach((room) => {
          url.pathname = `${URL_PREFIX}/r/${room.path}`;
          $list.append($('<a />', {
            class: 'list-group-item list-group-item-action',
            href: url.href,
            text: room.name
          }));
        });
      } else {
        handleAjaxError(this);
      }
    };
    xmlHttp.open('GET', `${URL_PREFIX}/rooms`);
    xmlHttp.send();
  </script>
</body>
